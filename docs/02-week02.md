# Week 2 {#week2}



<h2>Topics:</h2>
* [Code blocks in R](#rmdcodeblocks)
* [Graphs in R Markdown](#rmdgraphicss)
* [Tables in R Markdow](#rmdtables)
* [Equations in R Markdown](#rmdequations)
* [Captions and cross-references in R Markdown](#rmdcaptions)
* [Data sets:](#datasets002)
    * Data:
        * [Human Mortality Database](https://www.mortality.org/)
        * [Human Fertility Database](https://www.humanfertility.org/cgi-bin/main.php)


## Code to run for the in-class exercise



For the exercise in class, download [week02.R](r_code/week02.R), which we will use to run the code listed in this R Markdown result.

## R Markdown 

### Code blocks {#rmdcodeblocks}

### Graphics in R Markdown {#rmdgraphics}
Data-driven graphics in Rmd files are typically created as base R graphics or with the `ggplot2` package. This tutorial is not intended to provide anywhere near a comprehensive treatment of creating graphics from data, but will provide instruction on some options for creating and including data-driven graphics as well as inserting graphics from image files.

See [Tips and tricks for working with images and figures in R Markdown documents](http://zevross.com/blog/2017/06/19/tips-and-tricks-for-working-with-images-and-figures-in-r-markdown-documents/) for a good explanation.

#### Base R graphics
To include base R graphics, simply place the code to generate the graphic in an R code block, e.g., using the Add Health data from last week ([AHWave1_v1.dta](data/AHWave1_v1.dta)):


````
```{r}
# since loading the data takes awhile, only do this if necessary
if(!exists("dat")){
    dat <- read.dta13("data/AHwave1_v1.dta")
}
# birth year = h1gi1y
# drop "Refused" birth year
# for birth year and interview year, replace anything before white space, convert to numeric
# subtract interview year - birth year
ages <- dat %>% 
    filter(! str_detect(h1gi1y, "Refused")) %>% 
    select(iyear, h1gi1y) %>% 
    mutate(yi = str_replace(iyear, ".*\\s", "") %>% as.numeric(),
           yb = str_replace(h1gi1y, ".*\\s", "") %>% as.numeric(),
           age = yi - yb)
           
# create a histogram using base graphics
hist(ages$age, xlab = "age (years)", las = 1)
```
````

... which will render the graph:

<img src="02-week02_files/figure-html/unnamed-chunk-4-1.png" width="672" />

#### `ggplot2` graphics
The `ggplot2` package creates compelling graphics that use a common syntax. The main difference between base R graphics and `ggplot2` graphics is that simply issuing the `plot()` or related command (e.g., `hist()`, `barplot()`) adds the graphic to the output, whereas with `ggplot()` it is necessary to issue a command that prints the graphic.

Following the previous example:


```r
# how many unique bins? 
bins <- length(unique(ages$age))

# create the graphic
g <- ggplot(data = ages, mapping = aes(x = age)) +
    geom_histogram(bins = bins)

# print the graphic
print(g)
```

<img src="02-week02_files/figure-html/unnamed-chunk-5-1.png" width="672" />


#### Embedding graphics files
Journals frequently require graphics files to be submitted separately from the manuscript. In this case, the graphic can be created and saved as a file and then inserted in the Rmd using code, but also accessed as a a stand-alone file. Let's take the previous example, but add correlation coefficients and other embellishments, create a graphics file and add the graphics into the Rmd.

The base graphics file is created using the `pdf()` function, although `png()` also works if that is the desired output format. PDF is a vector format, so it generally renders better over different zoom levels.


```r
pdf(file = "ah_age_hist.pdf", width = 5, height = 5)
hist(ages$age, xlab = "age (years)", las = 1)
x <- dev.off()
```

Here we create a PNG format file:


```r
png(file = "ah_age_hist.png", width = 5, height = 5, units = "in", res = 300)
hist(ages$age, xlab = "age (years)", las = 1)
x <- dev.off()
```

`ggplot2` graphics can be saved using `ggsave()`, e.g., for both PDF and PNG outputs. The `dpi` argument is important for bitmap images.


```r
ggsave(
    filename = "ah_age_hist_ggplot.pdf",
    plot = g, device = "pdf",
    width = 5, height = 5
)
ggsave(
    filename = "ah_age_hist_ggplot.png",
    plot = g, device = "png", 
    width = 5, height = 5, 
    units = "in", dpi = 300
)
```

Graphics can be added using several methods.

##### `knitr`
The `knitr::include_graphics()` function can be used to insert image files, with the caution that inserted PDF files may produce unwanted results. The syntax is:


````
```{r}
include_graphics("graphics_filename")
```
````

and the code chunk can include `out.width`, `out.height` and other options.
\  
Here we insert a PDF with no code chunk options, which presents the image with a scroll bar, rather than the full image:


```r
include_graphics("ah_age_hist.pdf")
```

![](ah_age_hist.pdf)<!-- -->

Here we specify in the code chunk options `out.height = "360px", out.width='360px', fig.align='left'`, 


```r
include_graphics("ah_age_hist.pdf")
```

<embed src="ah_age_hist.pdf" width="360px" height="360px" style="display: block; margin: auto auto auto 0;" type="application/pdf" />

\  

... and with code chunk options `out.height = "400px", out.width='100%', fig.align='left'`


```r
include_graphics("ah_age_hist.pdf")
```

<embed src="ah_age_hist.pdf" width="100%" height="400px" style="display: block; margin: auto auto auto 0;" type="application/pdf" />

\  

It seems that embedding PDF files is not optimal.

Here we insert a PNG: with no code chunk options:


```r
include_graphics("ah_age_hist_ggplot.png")
```

<img src="ah_age_hist_ggplot.png" width="750" />

and with code chunk option `out.width = "50%"`


```r
include_graphics("ah_age_hist_ggplot.png")
```

<img src="ah_age_hist_ggplot.png" width="50%" />

So embedding bitmapped images appears to work better than embedding PDF files. 

##### Markdown: `![caption](filename)`

The native Markdown syntax:

```
![](filename)
```

includes a graphics file with an optional caption, e.g., here, a PDF with no caption, 

`![](ah_age_hist.pdf)`

![](ah_age_hist.pdf)

\  

The structure `![]()` indicates this is an inserted graphic; a caption can be specified by including text within the square brackets, e.g., displays the caption below the inserted image (but with no caption number!). 

```![Add Health respondent age histogram](ah_age_hist_ggplot.pdf)```

![Add Health respondent age histogram](ah_age_hist_ggplot.pdf)

... although it seems that inserting a PDF does odd things with image scrolling, while a PNG inserts the complete image without scroll bars.

```![Add Health respondent age histogram](ah_age_hist_ggplot.png)```:

![Add Health respondent age histogram](ah_age_hist_ggplot.png)

##### HTML `<img>` tag
If the file is to be rendered as HTML, _and_ the image is a bitmap, rather than vector PDF graphics, the `<img>` tag can be used. Different utilities can be used to convert PDF to bitmapped formats, e.g., [ImageMagick](https://imagemagick.org/index.php) and [GraphicsMagick](http://www.graphicsmagick.org/).

```<img src="ah_age_hist_ggplot.png">```

<img src="ah_age_hist_ggplot.png">

Including a percentage of page width:

```<img src="ah_age_hist_ggplot.png" width="30%">```

<img src="ah_age_hist_ggplot.png" width="30%">


### Tables in R Markdown {#rmdtables}

We will look at three methods of including tables in R Markdown documents, using the packages `knitr` (with `kableExtra`), `pander`, and `stargazer`.

For the example table, we will use the frequency table of health $\times$ White and African American from Assignment 2:


```r
dat <- readstata13::read.dta13("http://staff.washington.edu/phurvitz/csde502_winter_2021/data/AHwave1_v1.dta")


# ordered factor; use fct_rev to establish the correct ordering where better health ranks higher
dat %<>% 
    mutate(h1gh1 = fct_rev(as.ordered(h1gh1)))

# stratify health; first we need to catch the "don't know" and "refused" as NAs
dat %<>%  
    mutate(health = 
    case_when(
        h1gh1 <= "(6) Refused" ~ as.character(NA),
        h1gh1 >  "(3) Good" ~ "high",
        h1gh1 <= "(3) Good" ~ "low"
    ))

# tabulate by White
tabhealth_white <- dat %>% 
    group_by(health, white = h1gi6a) %>% 
    summarise(n = n(), .groups = "drop_last") %>% 
    mutate("%" = round(n / sum(n) * 100, 2))

# tabulate by African American
tabhealth_afram <- dat %>% 
    group_by(health, afram = h1gi6b) %>% 
    summarise(n = n(), .groups = "drop_last") %>% 
    mutate("%" = round(n / sum(n) * 100, 2))

# column-bind and remove the second "health" column
sum_health_white_afram <- cbind(tabhealth_white, tabhealth_afram) %>% 
    select(-5)
```

#### `kntir` (`kable()`) and `kableExtra`
The simple table using `kable()` is not too nice to read.


```r
kable(sum_health_white_afram)
```

<table>
 <thead>
  <tr>
   <th style="text-align:left;"> health...1 </th>
   <th style="text-align:left;"> white </th>
   <th style="text-align:right;"> n...3 </th>
   <th style="text-align:right;"> %...4 </th>
   <th style="text-align:left;"> afram </th>
   <th style="text-align:right;"> n...7 </th>
   <th style="text-align:right;"> %...8 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1486 </td>
   <td style="text-align:right;"> 33.36 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 3309 </td>
   <td style="text-align:right;"> 74.28 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 2962 </td>
   <td style="text-align:right;"> 66.49 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1139 </td>
   <td style="text-align:right;"> 25.57 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 704 </td>
   <td style="text-align:right;"> 34.49 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1553 </td>
   <td style="text-align:right;"> 76.09 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1328 </td>
   <td style="text-align:right;"> 65.07 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 479 </td>
   <td style="text-align:right;"> 23.47 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
  </tr>
</tbody>
</table>

So we add some `kabelExtra` options, :


```r
kable(sum_health_white_afram,
      col.names = c("health", "race", "n", "%", "race", "n", "%")) %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left") 
```

<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; ">
 <thead>
  <tr>
   <th style="text-align:left;"> health </th>
   <th style="text-align:left;"> race </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:right;"> % </th>
   <th style="text-align:left;"> race </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:right;"> % </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1486 </td>
   <td style="text-align:right;"> 33.36 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 3309 </td>
   <td style="text-align:right;"> 74.28 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 2962 </td>
   <td style="text-align:right;"> 66.49 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1139 </td>
   <td style="text-align:right;"> 25.57 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 704 </td>
   <td style="text-align:right;"> 34.49 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1553 </td>
   <td style="text-align:right;"> 76.09 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1328 </td>
   <td style="text-align:right;"> 65.07 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 479 </td>
   <td style="text-align:right;"> 23.47 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
  </tr>
</tbody>
</table>

However, because some column names are duplicated, it is necessary to add some column grouping:


```r
kable(sum_health_white_afram,
      col.names = c("health", "race", "n", "%", "race", "n", "%")) %>% 
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left") %>% 
    add_header_above(c(" " = 1, "White" = 3, "African American" = 3))
```

<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; ">
 <thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="1"></th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">White</div></th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">African American</div></th>
</tr>
  <tr>
   <th style="text-align:left;"> health </th>
   <th style="text-align:left;"> race </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:right;"> % </th>
   <th style="text-align:left;"> race </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:right;"> % </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1486 </td>
   <td style="text-align:right;"> 33.36 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 3309 </td>
   <td style="text-align:right;"> 74.28 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 2962 </td>
   <td style="text-align:right;"> 66.49 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1139 </td>
   <td style="text-align:right;"> 25.57 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 704 </td>
   <td style="text-align:right;"> 34.49 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1553 </td>
   <td style="text-align:right;"> 76.09 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1328 </td>
   <td style="text-align:right;"> 65.07 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 479 </td>
   <td style="text-align:right;"> 23.47 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
  </tr>
</tbody>
</table>

We could also add some row groupings:


```r
sum_health_white_afram %>% 
    select(-1) %>% 
    kable(col.names = c("race", "n", "%", "race", "n", "%"), align=c(rep('r',times=6))) %>% 
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left") %>% 
    add_header_above(c("White" = 3, "African American" = 3)) %>% 
    pack_rows("health high", 1, 4) %>% 
    pack_rows("health low", 5, 8) %>% 
    pack_rows("health N/A", 9, 12)
```

<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; ">
 <thead>
<tr>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">White</div></th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">African American</div></th>
</tr>
  <tr>
   <th style="text-align:right;"> race </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:right;"> % </th>
   <th style="text-align:right;"> race </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:right;"> % </th>
  </tr>
 </thead>
<tbody>
  <tr grouplength="4"><td colspan="6" style="border-bottom: 1px solid;"><strong>health high</strong></td></tr>
<tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (0) Not marked </td>
   <td style="text-align:right;"> 1486 </td>
   <td style="text-align:right;"> 33.36 </td>
   <td style="text-align:right;"> (0) Not marked </td>
   <td style="text-align:right;"> 3309 </td>
   <td style="text-align:right;"> 74.28 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (1) Marked </td>
   <td style="text-align:right;"> 2962 </td>
   <td style="text-align:right;"> 66.49 </td>
   <td style="text-align:right;"> (1) Marked </td>
   <td style="text-align:right;"> 1139 </td>
   <td style="text-align:right;"> 25.57 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
   <td style="text-align:right;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:right;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
  </tr>
  <tr grouplength="4"><td colspan="6" style="border-bottom: 1px solid;"><strong>health low</strong></td></tr>
<tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (0) Not marked </td>
   <td style="text-align:right;"> 704 </td>
   <td style="text-align:right;"> 34.49 </td>
   <td style="text-align:right;"> (0) Not marked </td>
   <td style="text-align:right;"> 1553 </td>
   <td style="text-align:right;"> 76.09 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (1) Marked </td>
   <td style="text-align:right;"> 1328 </td>
   <td style="text-align:right;"> 65.07 </td>
   <td style="text-align:right;"> (1) Marked </td>
   <td style="text-align:right;"> 479 </td>
   <td style="text-align:right;"> 23.47 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:right;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
   <td style="text-align:right;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
  </tr>
  <tr grouplength="4"><td colspan="6" style="border-bottom: 1px solid;"><strong>health N/A</strong></td></tr>
<tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (0) Not marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:right;"> (0) Not marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (1) Marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
   <td style="text-align:right;"> (1) Marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:right;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:right;padding-left: 2em;" indentlevel="1"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:right;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
  </tr>
</tbody>
</table>

#### `stargazer`
The [`stargazer`](https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf) package is especially good for PDF outputs, but is fairly limited for HTML output.


```r
stargazer(sum_health_white_afram, 
          type = "html", 
          summary = FALSE,
          rownames = FALSE)
```


<table style="text-align:center"><tr><td colspan="7" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">health...1</td><td>white</td><td>n...3</td><td>%...4</td><td>afram</td><td>n...7</td><td>%...8</td></tr>
<tr><td colspan="7" style="border-bottom: 1px solid black"></td></tr><tr><td style="text-align:left">high</td><td>1</td><td>1486</td><td>33.36</td><td>1</td><td>3309</td><td>74.28</td></tr>
<tr><td style="text-align:left">high</td><td>2</td><td>2962</td><td>66.49</td><td>2</td><td>1139</td><td>25.57</td></tr>
<tr><td style="text-align:left">high</td><td>3</td><td>2</td><td>0.04</td><td>3</td><td>2</td><td>0.04</td></tr>
<tr><td style="text-align:left">high</td><td>4</td><td>5</td><td>0.11</td><td>4</td><td>5</td><td>0.11</td></tr>
<tr><td style="text-align:left">low</td><td>1</td><td>704</td><td>34.49</td><td>1</td><td>1553</td><td>76.09</td></tr>
<tr><td style="text-align:left">low</td><td>2</td><td>1328</td><td>65.07</td><td>2</td><td>479</td><td>23.47</td></tr>
<tr><td style="text-align:left">low</td><td>3</td><td>1</td><td>0.05</td><td>3</td><td>1</td><td>0.05</td></tr>
<tr><td style="text-align:left">low</td><td>4</td><td>8</td><td>0.39</td><td>4</td><td>8</td><td>0.39</td></tr>
<tr><td style="text-align:left"></td><td>1</td><td>1</td><td>12.5</td><td>1</td><td>4</td><td>50</td></tr>
<tr><td style="text-align:left"></td><td>2</td><td>4</td><td>50</td><td>2</td><td>1</td><td>12.5</td></tr>
<tr><td style="text-align:left"></td><td>3</td><td>1</td><td>12.5</td><td>3</td><td>1</td><td>12.5</td></tr>
<tr><td style="text-align:left"></td><td>4</td><td>2</td><td>25</td><td>4</td><td>2</td><td>25</td></tr>
<tr><td colspan="7" style="border-bottom: 1px solid black"></td></tr></table>

#### `pander`
`pander` can be used to create output HTML tables as well, although also with fewer options than `knitr` with `kableExtra`.


```r
pander(sum_health_white_afram)
```


------------------------------------------------------------------------------
 health...1       white        n...3   %...4       afram        n...7   %...8 
------------ ---------------- ------- ------- ---------------- ------- -------
    high      (0) Not marked   1486    33.36   (0) Not marked   3309    74.28 

    high        (1) Marked     2962    66.49     (1) Marked     1139    25.57 

    high       (6) Refused       2     0.04     (6) Refused       2     0.04  

    high      (8) Don't know     5     0.11    (8) Don't know     5     0.11  

    low       (0) Not marked    704    34.49   (0) Not marked   1553    76.09 

    low         (1) Marked     1328    65.07     (1) Marked      479    23.47 

    low        (6) Refused       1     0.05     (6) Refused       1     0.05  

    low       (8) Don't know     8     0.39    (8) Don't know     8     0.39  

     NA       (0) Not marked     1     12.5    (0) Not marked     4      50   

     NA         (1) Marked       4      50       (1) Marked       1     12.5  

     NA        (6) Refused       1     12.5     (6) Refused       1     12.5  

     NA       (8) Don't know     2      25     (8) Don't know     2      25   
------------------------------------------------------------------------------

### Captions to support tables, figures, and equations {#rmdcaptions}
There are several ways to support captions in R Markdown. The two main requirements for good captions: (1) automatic sequential numbering, and (2) ability to cross-reference.

Here are some options for adding captions:

#### Figures

##### R Markdown code chunk `fig.cap`
Code chunks can include `fig_cap` as an option, as shown below. However, in standard Rmd $\rightarrow$ HTML there does not appear to be a method for cross-referencing. The code chunk would look like


````
```{r plotcars, fig.cap="Cars: speed and distance"}
plot(cars)
```
````


<div class="figure">
<img src="02-week02_files/figure-html/plotcars-1.png" alt="Cars: speed and distance" width="672" />
<p class="caption">(\#fig:plotcars)Cars: speed and distance</p>
</div>

##### `bookdown` with `html_document2` output type

Using the `bookdown` package with `html_document2` output type, it is possible to cross-reference using the chunk name. For example, download and run this code [fig_cap_bookdown.Rmd](files/fig_cap_bookdown.Rmd)

Which renders a file:

![](images/week03/fig_ref.png)

There seems to be no difference in the HTML output using

```
output: 
    bookdown::html_document2:
```

versus 

```
output: 
    html_document:
````

so the former is suggested as one way to include captions that support cross-referencing.

#### Tables: `kable()` "caption"
Tables created with `kable()` can include the `caption` option. For example:


```r
kable(x = sum_health_white_afram, caption = "Self-reported health by race")
```

<table>
<caption>(\#tab:unnamed-chunk-23)Self-reported health by race</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> health...1 </th>
   <th style="text-align:left;"> white </th>
   <th style="text-align:right;"> n...3 </th>
   <th style="text-align:right;"> %...4 </th>
   <th style="text-align:left;"> afram </th>
   <th style="text-align:right;"> n...7 </th>
   <th style="text-align:right;"> %...8 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1486 </td>
   <td style="text-align:right;"> 33.36 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 3309 </td>
   <td style="text-align:right;"> 74.28 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 2962 </td>
   <td style="text-align:right;"> 66.49 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1139 </td>
   <td style="text-align:right;"> 25.57 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> high </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 704 </td>
   <td style="text-align:right;"> 34.49 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1553 </td>
   <td style="text-align:right;"> 76.09 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1328 </td>
   <td style="text-align:right;"> 65.07 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 479 </td>
   <td style="text-align:right;"> 23.47 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.05 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> low </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.39 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:left;"> (0) Not marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 50.00 </td>
   <td style="text-align:left;"> (1) Marked </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
   <td style="text-align:left;"> (6) Refused </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 12.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:left;"> (8) Don't know </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 25.00 </td>
  </tr>
</tbody>
</table>

But there appears to be no direct way of cross-referencing within standard Rmd $\rightarrow$ HTML.

##### `bookdown` with `html_document2` output type

Similarly for figures, the `bookdown` package with `html_document2` output type, it is possible to cross-reference using the chunk name. For example, download and run this code [table_cap_bookdown.Rmd](files/table_cap_bookdown.Rmd)

Which renders a file:

![](images/week03/tab_ref.png)

#### Equations {# rmdequations}
Equations should be numbered in manuscripts. Using `bookdown` makes this quite easy. The equations themselves require $\LaTeX$ syntax. There are numerous web sites with examples and tutorials for creating mathematical expressions with $\LaTeX$ In this example, we include Einstein's famous equation:

<pre>
\begin{equation}
  E=mc^2
  (\#eq:emc)
\end{equation}
</pre>

and the sum of squares:

<pre>
\begin{equation}
  \sum_{i=1}^n i^2 = \frac{n(n+1)(2n+1)}{6}
  (\#eq:sumn)
\end{equation}
</pre>

The label for the equation is set with `(\#eq:emc)` and can be referenced using `\@ref(eq:emc)`. Operationalized, we see:

Einstein's equation, energy equals mass times the square of the speed of light is shown in \@ref(eq:emc).

\begin{equation}
  E=mc^2
  (\#eq:emc)
\end{equation}

To make a sum of squares of _n_ first integers, see \@ref(eq:sumn).

\begin{equation}
  \sum_{i=1}^n i^2 = \frac{n(n+1)(2n+1)}{6}
  (\#eq:sumn)
\end{equation}


### `captioner` for any captioning and cross-referencing figures and tables
The `captioner` package provides a flexible, albeit cumbersome, framework for captioning both tables and figures. 

The R code to do this:

```
library(captioner)
table_nums <- captioner(prefix = "Table")
figure_nums <- captioner(prefix = "Figure")
```

The `table_nums()` and `figure_nums()` functions are used to create captions and cross-references, and are not tied to any specific figure or table, as is the case with `kable` table captions and R code chunk `fig.cap`.

A caption is created, e.g., for a figure:

`` `r
figure_nums(name = "figname", caption = "My Caption")` ``

and referenced, e.g., 

`` `r
figure_nums(name = "figname", display = "cite")` ``

It does not matter whether the reference precedes or comes after the caption itself.

Another benefit to using `captioner` is that the output can be formatted using markdown syntax. For example, to format the caption in italics, use underscores:

`` _`r
figure_nums(name = "figname", caption = "My Caption")`_ ``

Although this method requires a bit more coding, it allows great flexibility. A complete example:

As shown in figure  1, the distribution of age has a slight negative skew.


```r
# how many unique bins? 
bins <- length(unique(ages$age))

# create the graphic
g <- ggplot(data = ages, mapping = aes(x = age)) +
    geom_histogram(bins = bins)

# print the graphic
print(g)
```

<img src="02-week02_files/figure-html/unnamed-chunk-24-1.png" width="288" />

_figure  1: Add Health age histogram_

Similarly, we can present the same data as a frequency table, as shown in table  1.

_table  1: Add Health age frequency table_


```r
ages %>% 
    group_by(age) %>% 
    summarise(n = n()) %>% 
    mutate(cumsum = cumsum(n),
        "%" = round(n / sum(n) * 100, 1),
        "cum %" = round(cumsum(n / sum(n) * 100), 1)) %>% 
    kable() %>% 
    kable_styling(bootstrap_options = 
        c("striped", "hover", "condensed", "responsive"), 
        full_width = F, 
        position = "left") 
```

<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; ">
 <thead>
  <tr>
   <th style="text-align:right;"> age </th>
   <th style="text-align:right;"> n </th>
   <th style="text-align:right;"> cumsum </th>
   <th style="text-align:right;"> % </th>
   <th style="text-align:right;"> cum % </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 12 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 0.1 </td>
   <td style="text-align:right;"> 0.1 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> 578 </td>
   <td style="text-align:right;"> 587 </td>
   <td style="text-align:right;"> 8.9 </td>
   <td style="text-align:right;"> 9.0 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:right;"> 903 </td>
   <td style="text-align:right;"> 1490 </td>
   <td style="text-align:right;"> 13.9 </td>
   <td style="text-align:right;"> 22.9 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 15 </td>
   <td style="text-align:right;"> 1081 </td>
   <td style="text-align:right;"> 2571 </td>
   <td style="text-align:right;"> 16.6 </td>
   <td style="text-align:right;"> 39.5 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:right;"> 1162 </td>
   <td style="text-align:right;"> 3733 </td>
   <td style="text-align:right;"> 17.9 </td>
   <td style="text-align:right;"> 57.4 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 17 </td>
   <td style="text-align:right;"> 1169 </td>
   <td style="text-align:right;"> 4902 </td>
   <td style="text-align:right;"> 18.0 </td>
   <td style="text-align:right;"> 75.4 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 18 </td>
   <td style="text-align:right;"> 1149 </td>
   <td style="text-align:right;"> 6051 </td>
   <td style="text-align:right;"> 17.7 </td>
   <td style="text-align:right;"> 93.1 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 19 </td>
   <td style="text-align:right;"> 389 </td>
   <td style="text-align:right;"> 6440 </td>
   <td style="text-align:right;"> 6.0 </td>
   <td style="text-align:right;"> 99.1 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 20 </td>
   <td style="text-align:right;"> 43 </td>
   <td style="text-align:right;"> 6483 </td>
   <td style="text-align:right;"> 0.7 </td>
   <td style="text-align:right;"> 99.7 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 21 </td>
   <td style="text-align:right;"> 18 </td>
   <td style="text-align:right;"> 6501 </td>
   <td style="text-align:right;"> 0.3 </td>
   <td style="text-align:right;"> 100.0 </td>
  </tr>
</tbody>
</table>




