<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Week 5 | UW CSDE 502 A Course Notes</title>
<meta name="author" content="Phil Hurvitz">
<meta name="description" content=".und {  text-decoration: underline; } Topics: Human Fertility Database (age-specific rates and summary indicators); Git  This week we will be covering two topics: Human Fertility Database...">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="Chapter 5 Week 5 | UW CSDE 502 A Course Notes">
<meta property="og:type" content="book">
<meta property="og:description" content=".und {  text-decoration: underline; } Topics: Human Fertility Database (age-specific rates and summary indicators); Git  This week we will be covering two topics: Human Fertility Database...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Week 5 | UW CSDE 502 A Course Notes">
<meta name="twitter:description" content=".und {  text-decoration: underline; } Topics: Human Fertility Database (age-specific rates and summary indicators); Git  This week we will be covering two topics: Human Fertility Database...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.20/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">UW CSDE 502 A Course Notes</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction and Welcome!</a></li>
<li><a class="" href="week1.html"><span class="header-section-number">1</span> Week 1</a></li>
<li><a class="" href="week2.html"><span class="header-section-number">2</span> Week 2</a></li>
<li><a class="" href="week3.html"><span class="header-section-number">3</span> Week 3</a></li>
<li><a class="" href="week4.html"><span class="header-section-number">4</span> Week 4</a></li>
<li><a class="active" href="week5.html"><span class="header-section-number">5</span> Week 5</a></li>
<li><a class="" href="week6.html"><span class="header-section-number">6</span> Week 6</a></li>
<li><a class="" href="week7.html"><span class="header-section-number">7</span> Week 7</a></li>
<li><a class="" href="week8.html"><span class="header-section-number">8</span> Week 8</a></li>
<li><a class="" href="week9.html"><span class="header-section-number">9</span> Week 9</a></li>
<li><a class="" href="week10.html"><span class="header-section-number">10</span> Week 10</a></li>
<li><a class="" href="assignment_files.html"><span class="header-section-number">11</span> Assignment support files</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/CSDE-UW/csde502-winter-2022">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="week5" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Week 5<a class="anchor" aria-label="anchor" href="#week5"><i class="fas fa-link"></i></a>
</h1>
<style>
.und {
  text-decoration: underline;
}
</style>
<h2>
Topics: Human Fertility Database (age-specific rates and summary indicators); Git
<a class="anchor" aria-label="anchor" href="#week5"><i class="fas fa-link"></i></a>
</h2>
<p>This week we will be covering two topics:</p>
<ul>
<li><a href="week5.html#hmdrevisit">Human Fertility Database (age-specific rates and summary indicators)</a></li>
<li><a href="week5.html#git">Git</a></li>
</ul>
<div id="hmdrevisit" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Human Fertility Database (age-specific rates and summary indicators)<a class="anchor" aria-label="anchor" href="#hmdrevisit"><i class="fas fa-link"></i></a>
</h2>
<p>CSDE 533 will be looking more at the Human Fertility Database (HFD). This brief section will cover the HFD in a bit more detail than in <a href="week2.html#datasets002">Week 2</a></p>
<div id="country-code-abbreviations" class="section level3" number="5.1.1">
<h3>
<span class="header-section-number">5.1.1</span> Country code abbreviations<a class="anchor" aria-label="anchor" href="#country-code-abbreviations"><i class="fas fa-link"></i></a>
</h3>
<p>In order to download data using <code><a href="https://rdrr.io/pkg/HMDHFDplus/man/readHFDweb.html">HMDHFDplus::readHFDweb()</a></code> two key pieces of information are needed, the country abbreviation and the coded item name.</p>
<p>First, we should be able to deal with country abbreviations. The <code>HMDHFDplus</code> package has the function <code><a href="https://rdrr.io/pkg/HMDHFDplus/man/getHFDcountries.html">getHFDcountries()</a></code> that returns the abbreviations shown at <a href="https://www.fertilitydata.org/cgi-bin/country_codes.php">Human Fertility Collection Country / area codes</a>. However, some of the country codes are not ISO standards. This next block of code will generate a tibble with the country abbreviations and country names used in the HFD (Table 1). This will help with formulating the download function.</p>
<div class="sourceCode" id="cb422"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ISOcodes</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/timriffe/TR1">HMDHFDplus</a></span><span class="op">)</span>

<span class="co"># HFD country codes</span>
<span class="va">hfdcodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/HMDHFDplus/man/getHFDcountries.html">getHFDcountries</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ccode <span class="op">=</span> <span class="va">.</span><span class="op">)</span>

<span class="co"># ISO country codes</span>
<span class="va">isocodes</span> <span class="op">&lt;-</span> <span class="va">ISO_3166_1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>ccode <span class="op">=</span> <span class="va">Alpha_3</span>, <span class="va">Name</span><span class="op">)</span>

<span class="co"># join ISO codes with country names</span>
<span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">isocodes</span>, by <span class="op">=</span> <span class="st">"ccode"</span><span class="op">)</span>

<span class="co"># there are some countries in the HFD that do not use standard 3 character ISO codes</span>
<span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Name</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 8 x 2
##   ccode   Name 
##   &lt;chr&gt;   &lt;chr&gt;
## 1 FRATNP  &lt;NA&gt; 
## 2 DEUTNP  &lt;NA&gt; 
## 3 DEUTW   &lt;NA&gt; 
## 4 DEUTE   &lt;NA&gt; 
## 5 GBR_NP  &lt;NA&gt; 
## 6 GBRTENW &lt;NA&gt; 
## 7 GBR_SCO &lt;NA&gt; 
## 8 GBR_NIR &lt;NA&gt;</code></pre>
<div class="sourceCode" id="cb424"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># update those</span>
<span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Name <span class="op">=</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">ccode</span> <span class="op">==</span> <span class="st">"FRATNP"</span> <span class="op">~</span>  <span class="st">"France"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"DEUTNP"</span> <span class="op">~</span>  <span class="st">"Germany"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"DEUTE"</span> <span class="op">~</span>   <span class="st">"East Germany"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"DEUTW"</span> <span class="op">~</span>   <span class="st">"West Germany"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"GBR_NP"</span> <span class="op">~</span>  <span class="st">"United Kingdom"</span>, 
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"GBRTENW"</span> <span class="op">~</span> <span class="st">"England and Wales"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"GBR_SCO"</span> <span class="op">~</span> <span class="st">"Scotland"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"GBR_NIR"</span> <span class="op">~</span> <span class="st">"Northern Ireland"</span>,
                  <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">Name</span><span class="op">)</span>
    <span class="op">)</span></code></pre></div>
<p><em>Table 1: HFD countries: codes and names</em></p>
<div class="sourceCode" id="cb425"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span>
                      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span><span class="op">)</span>, 
                  font_size <span class="op">=</span> <span class="fl">12</span>,
                  full_width <span class="op">=</span> <span class="cn">F</span>, position <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-striped table-hover table-condensed table-responsive" style="font-size: 12px; width: auto !important; ">
<thead><tr>
<th style="text-align:left;">
ccode
</th>
<th style="text-align:left;">
Name
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
AUT
</td>
<td style="text-align:left;">
Austria
</td>
</tr>
<tr>
<td style="text-align:left;">
BLR
</td>
<td style="text-align:left;">
Belarus
</td>
</tr>
<tr>
<td style="text-align:left;">
BGR
</td>
<td style="text-align:left;">
Bulgaria
</td>
</tr>
<tr>
<td style="text-align:left;">
CAN
</td>
<td style="text-align:left;">
Canada
</td>
</tr>
<tr>
<td style="text-align:left;">
CHL
</td>
<td style="text-align:left;">
Chile
</td>
</tr>
<tr>
<td style="text-align:left;">
HRV
</td>
<td style="text-align:left;">
Croatia
</td>
</tr>
<tr>
<td style="text-align:left;">
CZE
</td>
<td style="text-align:left;">
Czechia
</td>
</tr>
<tr>
<td style="text-align:left;">
DNK
</td>
<td style="text-align:left;">
Denmark
</td>
</tr>
<tr>
<td style="text-align:left;">
EST
</td>
<td style="text-align:left;">
Estonia
</td>
</tr>
<tr>
<td style="text-align:left;">
FIN
</td>
<td style="text-align:left;">
Finland
</td>
</tr>
<tr>
<td style="text-align:left;">
FRATNP
</td>
<td style="text-align:left;">
France
</td>
</tr>
<tr>
<td style="text-align:left;">
DEUTNP
</td>
<td style="text-align:left;">
Germany
</td>
</tr>
<tr>
<td style="text-align:left;">
DEUTW
</td>
<td style="text-align:left;">
West Germany
</td>
</tr>
<tr>
<td style="text-align:left;">
DEUTE
</td>
<td style="text-align:left;">
East Germany
</td>
</tr>
<tr>
<td style="text-align:left;">
HUN
</td>
<td style="text-align:left;">
Hungary
</td>
</tr>
<tr>
<td style="text-align:left;">
ISL
</td>
<td style="text-align:left;">
Iceland
</td>
</tr>
<tr>
<td style="text-align:left;">
ITA
</td>
<td style="text-align:left;">
Italy
</td>
</tr>
<tr>
<td style="text-align:left;">
JPN
</td>
<td style="text-align:left;">
Japan
</td>
</tr>
<tr>
<td style="text-align:left;">
LTU
</td>
<td style="text-align:left;">
Lithuania
</td>
</tr>
<tr>
<td style="text-align:left;">
NLD
</td>
<td style="text-align:left;">
Netherlands
</td>
</tr>
<tr>
<td style="text-align:left;">
NOR
</td>
<td style="text-align:left;">
Norway
</td>
</tr>
<tr>
<td style="text-align:left;">
POL
</td>
<td style="text-align:left;">
Poland
</td>
</tr>
<tr>
<td style="text-align:left;">
PRT
</td>
<td style="text-align:left;">
Portugal
</td>
</tr>
<tr>
<td style="text-align:left;">
KOR
</td>
<td style="text-align:left;">
Korea, Republic of
</td>
</tr>
<tr>
<td style="text-align:left;">
RUS
</td>
<td style="text-align:left;">
Russian Federation
</td>
</tr>
<tr>
<td style="text-align:left;">
SVK
</td>
<td style="text-align:left;">
Slovakia
</td>
</tr>
<tr>
<td style="text-align:left;">
SVN
</td>
<td style="text-align:left;">
Slovenia
</td>
</tr>
<tr>
<td style="text-align:left;">
ESP
</td>
<td style="text-align:left;">
Spain
</td>
</tr>
<tr>
<td style="text-align:left;">
SWE
</td>
<td style="text-align:left;">
Sweden
</td>
</tr>
<tr>
<td style="text-align:left;">
CHE
</td>
<td style="text-align:left;">
Switzerland
</td>
</tr>
<tr>
<td style="text-align:left;">
TWN
</td>
<td style="text-align:left;">
Taiwan, Province of China
</td>
</tr>
<tr>
<td style="text-align:left;">
UKR
</td>
<td style="text-align:left;">
Ukraine
</td>
</tr>
<tr>
<td style="text-align:left;">
GBR_NP
</td>
<td style="text-align:left;">
United Kingdom
</td>
</tr>
<tr>
<td style="text-align:left;">
GBRTENW
</td>
<td style="text-align:left;">
England and Wales
</td>
</tr>
<tr>
<td style="text-align:left;">
GBR_SCO
</td>
<td style="text-align:left;">
Scotland
</td>
</tr>
<tr>
<td style="text-align:left;">
GBR_NIR
</td>
<td style="text-align:left;">
Northern Ireland
</td>
</tr>
<tr>
<td style="text-align:left;">
USA
</td>
<td style="text-align:left;">
United States
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="hfd-items" class="section level3" number="5.1.2">
<h3>
<span class="header-section-number">5.1.2</span> HFD items<a class="anchor" aria-label="anchor" href="#hfd-items"><i class="fas fa-link"></i></a>
</h3>
<p>To download data using <code><a href="https://rdrr.io/pkg/HMDHFDplus/man/readHFDweb.html">HMDHFDplus::readHFDweb()</a></code>, it is necessary to specify the item name. For example at thee HFD page <a href="https://www.humanfertility.org/cgi-bin/country.php?country=USA&amp;tab=si">Unites States of America</a>, the first item listed is total number of live births for all birth orders combined between 1933 and 2019; the URL is <strong>www.humanfertility.org/cgi-bin/getfile.plx?f=USA\20210422<span class="und">totbirthsRR</span>.txt</strong> (where the item name is underlined).</p>
<p>Using Ben’s HFD code as a template, we can download the same item for several countries.</p>
<p>First, we create a generic function to download HFD data for a country and an item:</p>
<div class="sourceCode" id="cb426"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># a function to read HFD for one country and one item</span>
<span class="va">read_hfd_country</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">CNTRY</span>, <span class="va">item</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">HMDHFDplus</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/HMDHFDplus/man/readHFDweb.html">readHFDweb</a></span><span class="op">(</span>
    <span class="co"># the country from the function call</span>
    CNTRY <span class="op">=</span> <span class="va">CNTRY</span>,
    <span class="co"># the item to download</span>
    item <span class="op">=</span> <span class="va">item</span>,
    <span class="co"># the username from this key's record</span>
    username <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html">key_list</a></span><span class="op">(</span><span class="st">"human-mortality-database"</span><span class="op">)</span><span class="op">$</span><span class="va">username</span>,
    <span class="co"># the password for this key's record</span>
    password <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html">key_get</a></span><span class="op">(</span>
      service <span class="op">=</span> <span class="st">"human-mortality-database"</span>,
      username <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html">key_list</a></span><span class="op">(</span><span class="st">"human-mortality-database"</span><span class="op">)</span><span class="op">$</span><span class="va">username</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We then create a function to download an item for a set of countries</p>
<div class="sourceCode" id="cb427"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Download a data set iteratively for all named countries using purrr::map()</span>
<span class="va">read_hfd_countries_item</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">countries</span>, <span class="va">item</span><span class="op">)</span><span class="op">{</span>
    <span class="va">countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
        <span class="co"># Returns a list of data.frames, adding a column for country code to each</span>
        <span class="co"># the map() function performs a run of Ben's read_hmd_country() </span>
        <span class="co">#   function for each listed country</span>
        <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">ccode</span><span class="op">)</span> <span class="op">{</span>
            <span class="co"># the item to read is 1 x 1 death rates</span>
            <span class="fu">read_hfd_country</span><span class="op">(</span><span class="va">ccode</span>, <span class="va">item</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                <span class="co"># this adds the column "country" storing the country ISO code</span>
                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ccode <span class="op">=</span> <span class="va">ccode</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
        <span class="co"># Phil added this to make it a tibble</span>
        <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
        <span class="co"># and add country name</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">hfdcodes</span>, by <span class="op">=</span> <span class="st">"ccode"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Finally, run the function to download one item for a set of countries:</p>
<div class="sourceCode" id="cb428"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">CNTRIES</span> <span class="op">&lt;-</span> <span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"United States"</span>, <span class="st">"Lithuania"</span>, <span class="st">"Japan"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">ccode</span><span class="op">)</span>

<span class="va">totbirthsRR_USA_LTU_JPN</span> <span class="op">&lt;-</span> <span class="fu">read_hfd_countries_item</span><span class="op">(</span>countries <span class="op">=</span> <span class="va">CNTRIES</span>, item <span class="op">=</span> <span class="st">"totbirthsRR"</span><span class="op">)</span></code></pre></div>
<p>Let’s make a graph from that (Figure 1).</p>
<div class="sourceCode" id="cb429"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">totbirthsRR_USA_LTU_JPN</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>TotalM <span class="op">=</span> <span class="va">Total</span> <span class="op">/</span> <span class="fl">1000000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> 
       mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">TotalM</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Name</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"live births"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span></code></pre></div>
<p><img src="05-week05_files/figure-html/unnamed-chunk-7-1.png" width="672">
 <br><em>Figure 1: Live births x 1 million: Japan, Lithuania, USA (note non-standardized Y scale)</em></p>
</div>
</div>
<div id="git" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Git<a class="anchor" aria-label="anchor" href="#git"><i class="fas fa-link"></i></a>
</h2>
<p>This section is a brief introduction to <a href="https://git-scm.com/">Git</a>, the free and open source version control system for text-based files. Much of the material in this lesson is derived from the <a href="https://swcarpentry.github.io/git-novice/">Software Carpentry Git tutorial</a>.</p>
<div id="why-use-version-control" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Why use version control?<a class="anchor" aria-label="anchor" href="#why-use-version-control"><i class="fas fa-link"></i></a>
</h3>
<p>Version control is simply having control over various versions of your documents. In the context of code-based research using text files such as <code>.R</code>, <code>.Rmd</code>, <code>.tex</code>, <code>.sql</code>, <code>.do</code>, at the simplest level, version control means having the ability to track changes to your files. In more advanced levels, you should be able to revert to previous versions, collaborate with others and know who did what and when, or to merge together edits made by more than one person</p>
<p>We covered one form of version control in a previous assignment and in the section of this document on <a href="#file-systems">File systems</a>. The version control system was simply keeping copies of existing files and naming new files according to a temporal sequence, with date being the suggested method of nomenclature.</p>
<p>While keeping backup, dated copies of files is not necessarily a bad approach, it suffers from a few major limitations, including:</p>
<ol style="list-style-type: decimal">
<li>because it relies on saving different versions of a file, it can lead to a proliferation of files</li>
<li>it is not often easy to know what changes were made from version to version</li>
</ol>
<p>Jorge Cham’s (<a href="http://www.phdcomics.com">Piled Higher and Deeper</a>) comic points out what happens to a typical graduate student’s “final” version:</p>
<p><a href="http://www.phdcomics.com"><img src="images/week05/phd101212s.png"></a></p>
</div>
<div id="why-use-git" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> Why use Git?<a class="anchor" aria-label="anchor" href="#why-use-git"><i class="fas fa-link"></i></a>
</h3>
<p>Version controls systems have been in use since the early 1980s. Commonly used applications are RCS (Revision Control System), CVS (Concurrent Versions System), SVN (Subversion). However, some of these require centralized servers, are limited in their capabilities, and are not free.</p>
<p>Git has multiple advantages:</p>
<ul>
<li>free</li>
<li>supports complex work flows with branching, merging, etc., allowing multiple collaborators to work on the same set of files at the same time</li>
<li>does not require a centralized server (version control can be managed completely within a single computer)
<ul>
<li>it is possible to use online repositories, such as Github.com</li>
</ul>
</li>
<li>can be used within RStudio</li>
<li>has a large community of users (i.e., free advice)</li>
</ul>
</div>
<div id="limitations-of-version-control-systems" class="section level3" number="5.2.3">
<h3>
<span class="header-section-number">5.2.3</span> Limitations of version control systems<a class="anchor" aria-label="anchor" href="#limitations-of-version-control-systems"><i class="fas fa-link"></i></a>
</h3>
<p>Although version control systems are quite useful, there are some potential drawbacks.</p>
<ol style="list-style-type: decimal">
<li>requires learning yet another somewhat-complicated system</li>
<li>requires mindfulness
<ul>
<li>recorded changes are best performed interactively</li>
<li>can only “undo” changes that were committed</li>
</ul>
</li>
<li>designed for text files; cannot deal with binary files, e.g., Word or other formats</li>
</ol>
</div>
<div id="a-brief-git-tutorial" class="section level3" number="5.2.4">
<h3>
<span class="header-section-number">5.2.4</span> A brief Git tutorial<a class="anchor" aria-label="anchor" href="#a-brief-git-tutorial"><i class="fas fa-link"></i></a>
</h3>
<p>Here we will be using the basic functions of Git while building up an Rmd file.</p>
<div id="setting-up-git-in-rstudio" class="section level4" number="5.2.4.1">
<h4>
<span class="header-section-number">5.2.4.1</span> Setting up Git in RStudio<a class="anchor" aria-label="anchor" href="#setting-up-git-in-rstudio"><i class="fas fa-link"></i></a>
</h4>
<p>We will be working on CSDE Terminal Server 4 (see <a href="#getting-started-on-terminal-server-4">Getting started on Terminal Server 4</a>).</p>
<p>Start RStudio and open a web browser.</p>
</div>
<div id="creating-a-repository" class="section level4" number="5.2.4.2">
<h4>
<span class="header-section-number">5.2.4.2</span> Creating a repository<a class="anchor" aria-label="anchor" href="#creating-a-repository"><i class="fas fa-link"></i></a>
</h4>
<p>Using the web browser, go to <a href="http://github.com">Github.com</a> and create a repository named <code>git_r</code>.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_21_21_47.png"></div>
<p>Make the repository public and add a README file.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_21_37_13.png"></div>
<p>Switch back to RStudio and select <code>File &gt; New Project</code> and in the choice of project types, select <code>Version Control</code>. This will streamline the process of linking the RStudio project with Github.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_21_39_10.png"></div>
<p>Choose <code>Git</code> as the type of version control.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_21_39_46.png"></div>
<p>Enter the complete URL of your new Git repository. The project directly name should automatically be set as the base name pf the URL. If not, enter <code>git_r</code>.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_21_52_48.png"></div>
<p>Because we need to define where on the local file system the project files will be stored, click <code>Browse</code> and navigate to your <code>H:</code> drive (note that this is your UDrive).</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_21_53_32.png"></div>
<p>After you have specified the repository URL, project directory name, and parent directory of the project directory, click <code>Create Project</code>.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_21_54_04.png"></div>
</div>
<div id="tracking-changes" class="section level4" number="5.2.4.3">
<h4>
<span class="header-section-number">5.2.4.3</span> Tracking changes<a class="anchor" aria-label="anchor" href="#tracking-changes"><i class="fas fa-link"></i></a>
</h4>
<p>One of the files we will change is <a href="files/week_01.Rmd">week_01.Rmd</a>, so download this to the main folder of your project.</p>
<p>The first file we will make changes to is <code>README.md</code>.</p>
<p>Add some text explaining what purpose the repository serves.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_09_11.png"></div>
<p>Save the changes to the README.md file. If you do not see updates in the Git tab, click the <code>Refresh listing</code> button. You may need to do this frequently if your file changes are frequent. Note the status of files will only change when the files are saved.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_37_42.png"></div>
<p>You should see a blue “M” next to the README.md file. Click the check box for <code>Staged</code> to prepare to commit the changes to the file and prepare to push to the remote server.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_11_45.png"></div>
<p>Click <code>Commit</code> and a new window will open. Any deletions are shown with a light red background. Additions are shown with a light green background, and text that has not changed will have a white background.</p>
<p>Enter some explanatory text in the <code>Commit message</code> panel. This message will help identify historical commits. The explanatory text should succinctly describe any changes you have made.</p>
<p>The idea is to make commits each time you have substantially changed your code. If you wait too long between commits, the number of changes in a single commit may be unmanageable. But if commits are made too frequently, the number of commits may become unmanageable. Think of this similarly to how often you might make a new version of a document.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_15_28.png"></div>
<p>Next, we will perform an initial pull/push. It is recommended in multi-user environments to perform a pull from the online repository before pushing. This lets you download to your local file system any files that have been updated by others.</p>
<p>In the Git tab, click the <code>Pull</code> icon.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_17_19.png"></div>
<p>Since no changes have been made to the online files, we see the message “Already up to date.”</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_17_41.png"></div>
<p>Next, click the <code>Push</code> icon to upload any changed files.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_17_58.png"></div>
<p>At some point in the process of establishing the connection to Github, you may get some popups asking you to sign in. If this happens, proceed with the authorization.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_19_18.png"></div>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_19_59.png"></div>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_20_08.png"></div>
<p>When the authorization is completed, the push will proceed. Your screen will look different, but the last line of text here shows a truncated version of the unique hash (identifier) of the push transaction. This unique hash will allow you to download previous versions of the file in case you made commits and pushes that caused unintended consequences.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_20_32.png"></div>
<p>If you refresh the page for your repository, you should see the updates you made to the README.md file. This is the basic process for updating files, committing changes, and pushing to Github.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_21_18.png"></div>
<p>Perform the same steps (click <code>Staged</code> then <code>Commit</code> for week_01.Rmd). Because this is a new file that was not in the Github repository, when it is committed, it will show in all green since all of the text has been added.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_46_24.png"></div>
<p>Repeat the pull/push cycle and then refresh your browser to show that the file was added to the online Github repository.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_48_45.png"></div>
<p>If you click the file name you will see the contents.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_49_07.png"></div>
<p>Let’s make some changes to this file. Back in RStudio, add to the list of packages to load at line 51.</p>
<pre><code><a href="https://github.com/rstudio/htmltools">library(htmltools) # popup on Leaflet map</a></code></pre>
<p>Change the description at line 122 to read</p>
<pre><code>... for a Leaflet map that has the Space Needle, Savery Hall, and the Woodland Park Zoo.</code></pre>
<p>and change the code chunk to add two additional points and text popups for the point markers. The chunk should contain the following code:</p>
<pre><code># the Space Needle
snxy &lt;- data.frame(name = "Space Needle", x = -122.3493, y = 47.6205)
space_needle &lt;- st_as_sf(snxy, coords = c("x", "y"), crs = 4326)

# Savery Hall
shxy &lt;- data.frame(name = "Savery Hall", x = -122.3083, y = 47.6572)
savery_hall &lt;- st_as_sf(shxy, coords = c("x", "y"), crs = 4326)

# the Woodland Park Zoo
zooxy &lt;- data.frame(name = "Woodland Park Zoo", x = -122.3543, y = 47.6685)
wp_zoo &lt;- st_as_sf(zooxy, coords = c("x", "y"), crs = 4326)

# rbind() to put two points in one data frame
pts &lt;- rbind(space_needle, savery_hall, wp_zoo)

# a leaflet
m &lt;- leaflet() %&gt;% 
    addTiles() %&gt;% 
    addCircleMarkers(data = pts, label = ~htmlEscape(name))
m</code></pre>
<p>Save the edits to the file and then tap the “knit” button or enter at the console prompt <code>rmarkdown::render("week_01.Rmd")</code> to generate the HTML file. You should see that now there are three point markers, and if you hover over any of the markers you will see the name popup.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_32_50.png"></div>
</div>
<div id="git-bash-shell" class="section level4" number="5.2.4.4">
<h4>
<span class="header-section-number">5.2.4.4</span> Git bash shell<a class="anchor" aria-label="anchor" href="#git-bash-shell"><i class="fas fa-link"></i></a>
</h4>
<p>Another interface you can use is the Git bash shell. To open the shell, click <code>Tools &gt; Shell</code>.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_22_01_34.png"></div>
<p>All of the GUI commands we have used in RStudio are available in the shell. In fact, very little of the functionality of Git is available within RStudio. To take full advantage of Git, it is necessary to use the shell. There are a number of excellent tutorials on the use of the shell. For now because this is an introductory lesson, we will focus mainly on the RStudio interface,</p>
<p>The shell should be set to the project folder; if not you can enter e.g., <code>cd /H/git_r</code> (note that this corresponds to the Windows folder <code>H:\git_r</code>).</p>
<p>At the prompt, enter <code>git status</code>. This will show the status of all files, in this case showing that <code>week_01.Rmd</code> has been modified, and that there are some files that are not being tracked.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_36_02.png"></div>
</div>
<div id="ignoring-specific-files" class="section level4" number="5.2.4.5">
<h4>
<span class="header-section-number">5.2.4.5</span> Ignoring specific files<a class="anchor" aria-label="anchor" href="#ignoring-specific-files"><i class="fas fa-link"></i></a>
</h4>
<p>Sometimes we are not interested in particular files being committed or pushed to the repository. For version control, we are interested in managing the code that is used to create outputs rather than the outputs themselves, with the idea being that if you have the code, you can recreate any outputs.</p>
<p>So there are files that can be ignored, which are specified in the <code>.gitignore</code> file. Open the file and add the line <code>*.html</code>. This tells Git not to bother managing HTML files (under the assumption that these are the output of rendering Rmd files).</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_40_15.png"></div>
<p>Save the <code>.gitignore</code> file and re-run <code>git status</code> at the shell (by tapping the up arrow key on your keyboard and tapping Enter). You should see that the HTML file does not show up in the list of changed or untracked files.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_42_51.png"></div>
<p>Add the line <code>*.Rproj</code> to the <code>.gitignore</code> file–this file should not be necessary in the repository.</p>
<p>Likewise, if you refresh the Git tab in RStudio, the HTML file is no longer listed.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_43_13.png"></div>
<p>We will perform a few more tasks with the shell. Enter <code>add .gitignore</code> and <code>add week_01.Rmd</code>. This is the equivalent of clicking the <code>Staged</code> check box in RStudio.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_45_14.png"></div>
<p>Refreshing the Git tab in RStudio will show that these two files are staged. This demonstrates that the RStudio Git environment is up to date with any changes made using the Git shell, and vice versa.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_45_37.png"></div>
</div>
<div id="exploring-file-change-history" class="section level4" number="5.2.4.6">
<h4>
<span class="header-section-number">5.2.4.6</span> Exploring file change history<a class="anchor" aria-label="anchor" href="#exploring-file-change-history"><i class="fas fa-link"></i></a>
</h4>
<p>Click <code>Commit</code> to prepare to commit the changes (addition of <code>.gitignore</code> and the changes to <code>week_01.Rmd</code>).</p>
<p>As previously mentioned, deleted lines are shown in light red, added lines in light green, and unchanged lines with no highlighting. Click the entry for <code>week_01.Rmd</code> and the changes are apparent. Line numbers on the far left are the original line numbers. The next column to the right shows updated line numbers.</p>
<p>This allows you to compare the currently saved version against the previous version of the file.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_48_02.png"></div>
<p>Committing changes with the shell is done by entering</p>
<p><code>git commit -m "somecomment"</code></p>
<p>This has the same effect as clicking <code>Commit</code> in RStudio and entering the comment.</p>
<p>Note that if we have not made some initial user configurations, Git will print some informative text about your identity. To avoid this and to tag future commits, use the <code>git config --global</code> commands, e.g.,</p>
<p><code>git config --global user.name "My Full Name" git config --global user.email "myemailaddress@mydomain"</code></p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_51_55.png"></div>
<p>Once the commit is performed, either with the RStudio GUI or with the shell, you can verify that no files are listed to be possibly staged.</p>
<div class="inline-figure"><img src="images/week05/2021-02-04_23_53_10.png"></div>
<p>Perform another pull/push cycle and then refresh your web browser. Click on the commit comment.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_10_46.png"></div>
<p>You will see the changes to the two files in the last commit/push. The <code>.gitignore</code> file has all of its lines in green, indicating they are all new with respect to the repository. The file <code>week_01.Rmd</code> shows the same changes on Github as we saw in the local view before pushing the commit to the server.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_12_20.png"></div>
</div>
<div id="restoring-a-previous-version" class="section level4" number="5.2.4.7">
<h4>
<span class="header-section-number">5.2.4.7</span> Restoring a previous version<a class="anchor" aria-label="anchor" href="#restoring-a-previous-version"><i class="fas fa-link"></i></a>
</h4>
<p>What good are all of these tracked changes if we cannot revert to a previous version of a file? Here we will make some intentional bad edits to a file, commit and push, but then retrieve a previous version of the file. Any version can be recovered. Note that this does not mean you can recover any and all edits to a file. It only means you can recover what changed between commits. For example, if I made a commit/push at noon, then made a lot of changes and saved the file multiple times before 5 PM and then made a commit/push, there would only be two versions of the file available in Git, the one committed at noon, and the one committed at 5 PM. For this reason it is worth making commit/push cycles every time you thing you might want to revert to a previous version.</p>
<p>The intentional bad change to <code>week_01.Rmd</code> is the complete removal of the code that produces the Leaflet map. See the following image.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_13_13.png"></div>
<p>Perform the standard cycle: stage, commit (with a snarky comment), pull, and push.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_14_07.png"></div>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_14_24.png"></div>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_16_23.png"></div>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_17_10.png"></div>
<p>You should see the large swath of deleted lines</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_21_01.png"></div>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_22_10.png"></div>
<p>Back in the Github, find and click the file name.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_24_21.png"></div>
<p>The file contents will show the most recent saved version (missing the Leaflet map lines). Click on the <code>History</code> link, which will show all of the commits.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_25_05.png"></div>
<p>Click the commit where you followed the questionable advice from your advisor.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_25_23.png"></div>
<p>The missing lines are evident. What we would like to do is to go back to the version before the large deletion of lines.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_25_40.png"></div>
<p>Identify the previous commit and click the clipboard icon to the left of the first characters of the commit hash. This will copy the hash, which is necessary for restoring that version.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_39_46.png"></div>
<p>Back in the shell, enter</p>
<pre><code>git show *****</code></pre>
<p>where ***** is the hash. This will display encoded instructions for changes made to the file. Now enter</p>
<pre><code>git show *****:week_01.Rmd</code></pre>
<p>where <code>*****</code> is the hash.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_40_36.png"></div>
<p>This applies the changes to the file for the commit represented by the hash. You will see the text that was present at that commit, which includes the deleted Leaflet map.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_40_59.png"></div>
<p>To restore this previous version to a new file, enter</p>
<pre><code>git show *****:week_01.Rmd &gt; week_01_someadditionaldescription.Rmd</code></pre>
<p>This prints the contents of the previously committed file and redirects the output to the named file after the <code>&gt;</code> sign.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_45_16.png"></div>
<p>If you open that file, you will see the restored text.</p>
<div class="inline-figure"><img src="images/week05/2021-02-05_00_46_04.png"></div>
</div>
<div id="conclusion" class="section level4" number="5.2.4.8">
<h4>
<span class="header-section-number">5.2.4.8</span> Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"><i class="fas fa-link"></i></a>
</h4>
<p>This was a brief introduction to the main functionality of Git with RStudio and Github. If you expect to perform even a modest amount of coding, you could benefit from Git as a way to keep track of your work, collaborate with others, and avoid programming disasters due to inadvertent deletion of overwriting of files.</p>
<hr>
<p>Rendered at <tt>2022-02-19 10:11:41</tt></p>
<hr>
<p>Rendered at <tt>2022-02-19 10:11:41</tt></p>
</div>
</div>
</div>
<div id="source-code-4" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Source code<a class="anchor" aria-label="anchor" href="#source-code-4"><i class="fas fa-link"></i></a>
</h2>
<p>File is at H:/csde502-winter-2022-main/05-week05.Rmd.</p>
<div id="source-code-for-this-document-4" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> Source code for this document<a class="anchor" aria-label="anchor" href="#source-code-for-this-document-4"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb436"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">ISOcodes</span>, <span class="va">tidyverse</span>, <span class="va">magrittr</span>, <span class="va">knitr</span>, <span class="va">kableExtra</span>, <span class="va">readstata13</span>, <span class="va">HMDHFDplus</span>, <span class="va">captioner</span><span class="op">)</span>

<span class="va">figure_nums</span> <span class="op">&lt;-</span> <span class="fu">captioner</span><span class="op">(</span>prefix <span class="op">=</span> <span class="st">"Figure"</span><span class="op">)</span>
<span class="va">table_nums</span> <span class="op">&lt;-</span> <span class="fu">captioner</span><span class="op">(</span>prefix <span class="op">=</span> <span class="st">"Table"</span><span class="op">)</span>

<span class="co"># path to this file name</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">fnamepath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/current_input.html">current_input</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ISOcodes</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/timriffe/TR1">HMDHFDplus</a></span><span class="op">)</span>

<span class="co"># HFD country codes</span>
<span class="va">hfdcodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/HMDHFDplus/man/getHFDcountries.html">getHFDcountries</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>ccode <span class="op">=</span> <span class="va">.</span><span class="op">)</span>

<span class="co"># ISO country codes</span>
<span class="va">isocodes</span> <span class="op">&lt;-</span> <span class="va">ISO_3166_1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>ccode <span class="op">=</span> <span class="va">Alpha_3</span>, <span class="va">Name</span><span class="op">)</span>

<span class="co"># join ISO codes with country names</span>
<span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">isocodes</span>, by <span class="op">=</span> <span class="st">"ccode"</span><span class="op">)</span>

<span class="co"># there are some countries in the HFD that do not use standard 3 character ISO codes</span>
<span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Name</span><span class="op">)</span><span class="op">)</span>

<span class="co"># update those</span>
<span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Name <span class="op">=</span> 
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">ccode</span> <span class="op">==</span> <span class="st">"FRATNP"</span> <span class="op">~</span>  <span class="st">"France"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"DEUTNP"</span> <span class="op">~</span>  <span class="st">"Germany"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"DEUTE"</span> <span class="op">~</span>   <span class="st">"East Germany"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"DEUTW"</span> <span class="op">~</span>   <span class="st">"West Germany"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"GBR_NP"</span> <span class="op">~</span>  <span class="st">"United Kingdom"</span>, 
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"GBRTENW"</span> <span class="op">~</span> <span class="st">"England and Wales"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"GBR_SCO"</span> <span class="op">~</span> <span class="st">"Scotland"</span>,
                  <span class="va">ccode</span> <span class="op">==</span> <span class="st">"GBR_NIR"</span> <span class="op">~</span> <span class="st">"Northern Ireland"</span>,
                  <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">Name</span><span class="op">)</span>
    <span class="op">)</span>
<span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>bootstrap_options <span class="op">=</span>
                      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span><span class="op">)</span>, 
                  font_size <span class="op">=</span> <span class="fl">12</span>,
                  full_width <span class="op">=</span> <span class="cn">F</span>, position <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>
<span class="co"># a function to read HFD for one country and one item</span>
<span class="va">read_hfd_country</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">CNTRY</span>, <span class="va">item</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">HMDHFDplus</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/HMDHFDplus/man/readHFDweb.html">readHFDweb</a></span><span class="op">(</span>
    <span class="co"># the country from the function call</span>
    CNTRY <span class="op">=</span> <span class="va">CNTRY</span>,
    <span class="co"># the item to download</span>
    item <span class="op">=</span> <span class="va">item</span>,
    <span class="co"># the username from this key's record</span>
    username <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html">key_list</a></span><span class="op">(</span><span class="st">"human-mortality-database"</span><span class="op">)</span><span class="op">$</span><span class="va">username</span>,
    <span class="co"># the password for this key's record</span>
    password <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html">key_get</a></span><span class="op">(</span>
      service <span class="op">=</span> <span class="st">"human-mortality-database"</span>,
      username <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html">key_list</a></span><span class="op">(</span><span class="st">"human-mortality-database"</span><span class="op">)</span><span class="op">$</span><span class="va">username</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="co"># Download a data set iteratively for all named countries using purrr::map()</span>
<span class="va">read_hfd_countries_item</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">countries</span>, <span class="va">item</span><span class="op">)</span><span class="op">{</span>
    <span class="va">countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
        <span class="co"># Returns a list of data.frames, adding a column for country code to each</span>
        <span class="co"># the map() function performs a run of Ben's read_hmd_country() </span>
        <span class="co">#   function for each listed country</span>
        <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">ccode</span><span class="op">)</span> <span class="op">{</span>
            <span class="co"># the item to read is 1 x 1 death rates</span>
            <span class="fu">read_hfd_country</span><span class="op">(</span><span class="va">ccode</span>, <span class="va">item</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                <span class="co"># this adds the column "country" storing the country ISO code</span>
                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ccode <span class="op">=</span> <span class="va">ccode</span><span class="op">)</span>
        <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
        <span class="co"># Phil added this to make it a tibble</span>
        <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
        <span class="co"># and add country name</span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">hfdcodes</span>, by <span class="op">=</span> <span class="st">"ccode"</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">CNTRIES</span> <span class="op">&lt;-</span> <span class="va">hfdcodes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"United States"</span>, <span class="st">"Lithuania"</span>, <span class="st">"Japan"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">ccode</span><span class="op">)</span>

<span class="va">totbirthsRR_USA_LTU_JPN</span> <span class="op">&lt;-</span> <span class="fu">read_hfd_countries_item</span><span class="op">(</span>countries <span class="op">=</span> <span class="va">CNTRIES</span>, item <span class="op">=</span> <span class="st">"totbirthsRR"</span><span class="op">)</span>
<span class="va">totbirthsRR_USA_LTU_JPN</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>TotalM <span class="op">=</span> <span class="va">Total</span> <span class="op">/</span> <span class="fl">1000000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> 
       mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">TotalM</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Name</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"live births"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">fnamepath</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">'\n'</span><span class="op">)</span></code></pre></div>
</div>
<div id="complete-rmd-code-4" class="section level3" number="5.3.2">
<h3>
<span class="header-section-number">5.3.2</span> Complete Rmd code<a class="anchor" aria-label="anchor" href="#complete-rmd-code-4"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb437"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">fnamepath</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">'\n'</span><span class="op">)</span></code></pre></div>
<pre><code># Week 5 {#week5}

```{r, echo=FALSE, warning=FALSE, message=FALSE}
pacman::p_load(ISOcodes, tidyverse, magrittr, knitr, kableExtra, readstata13, HMDHFDplus, captioner)

figure_nums &lt;- captioner(prefix = "Figure")
table_nums &lt;- captioner(prefix = "Table")

# path to this file name
if (!interactive()) {
    fnamepath &lt;- current_input(dir = TRUE)
}
```

&lt;style&gt;
.und {
  text-decoration: underline;
}
&lt;/style&gt;

&lt;h2&gt;Topics: Human Fertility Database (age-specific rates and summary indicators); Git&lt;/h2&gt;

This week we will be covering two topics:

* [Human Fertility Database (age-specific rates and summary indicators)](#hmdrevisit)
* [Git](#git)

## Human Fertility Database (age-specific rates and summary indicators) {#hmdrevisit}
CSDE 533 will be looking more at the Human Fertility Database (HFD). This brief section will cover the HFD in a bit more detail than in [Week 2](#datasets002)

### Country code abbreviations
In order to download data using `HMDHFDplus::readHFDweb()` two key pieces of information are needed, the country abbreviation and the coded item name.

First, we should be able to deal with country abbreviations. The `HMDHFDplus` package has the function `getHFDcountries()` that returns the abbreviations shown at [Human Fertility Collection Country / area codes](https://www.fertilitydata.org/cgi-bin/country_codes.php). However, some of the country codes are not ISO standards. This next block of code will generate a tibble with the country abbreviations and country names used in the HFD (`r table_nums(name = "hfdcountries", display = "cite")`). This will help with formulating the download function.

```{r}
library(ISOcodes)
library(HMDHFDplus)

# HFD country codes
hfdcodes &lt;- getHFDcountries() %&gt;% tibble(ccode = .)

# ISO country codes
isocodes &lt;- ISO_3166_1 %&gt;% tibble() %&gt;% select(ccode = Alpha_3, Name)

# join ISO codes with country names
hfdcodes %&lt;&gt;% left_join(isocodes, by = "ccode")

# there are some countries in the HFD that do not use standard 3 character ISO codes
hfdcodes %&gt;% filter(is.na(Name))

# update those
hfdcodes %&lt;&gt;% 
    mutate(Name = 
        case_when(ccode == "FRATNP" ~  "France",
                  ccode == "DEUTNP" ~  "Germany",
                  ccode == "DEUTE" ~   "East Germany",
                  ccode == "DEUTW" ~   "West Germany",
                  ccode == "GBR_NP" ~  "United Kingdom", 
                  ccode == "GBRTENW" ~ "England and Wales",
                  ccode == "GBR_SCO" ~ "Scotland",
                  ccode == "GBR_NIR" ~ "Northern Ireland",
                  TRUE ~ Name)
    )
```

*`r table_nums(name = "hfdcountries", caption = "HFD countries: codes and names")`*

```{r}
hfdcodes %&gt;% 
    kable() %&gt;% 
    kable_styling(bootstrap_options =
                      c("striped", "hover", "condensed", "responsive"), 
                  font_size = 12,
                  full_width = F, position = "left")
```

### HFD items
To download data using `HMDHFDplus::readHFDweb()`, it is necessary to specify the item name. For example at thee HFD page [Unites States of America](https://www.humanfertility.org/cgi-bin/country.php?country=USA&amp;tab=si), the first item listed is total number of live births for all birth orders combined between 1933 and 2019; the URL is **www.humanfertility.org/cgi-bin/getfile.plx?f=USA\20210422\USA&lt;span class="und"&gt;totbirthsRR&lt;/span&gt;.txt** (where the item name is underlined).

Using Ben's HFD code as a template, we can download the same item for several countries.

First, we create a generic function to download HFD data for a country and an item:

```{r}
# a function to read HFD for one country and one item
read_hfd_country &lt;- function(CNTRY, item) {
  HMDHFDplus::readHFDweb(
    # the country from the function call
    CNTRY = CNTRY,
    # the item to download
    item = item,
    # the username from this key's record
    username = keyring::key_list("human-mortality-database")$username,
    # the password for this key's record
    password = keyring::key_get(
      service = "human-mortality-database",
      username = keyring::key_list("human-mortality-database")$username
    )
  )
}
```

We then create a function to download an item for a set of countries

```{r}
# Download a data set iteratively for all named countries using purrr::map()
read_hfd_countries_item &lt;- function(countries, item){
    countries %&gt;%
        # Returns a list of data.frames, adding a column for country code to each
        # the map() function performs a run of Ben's read_hmd_country() 
        #   function for each listed country
        purrr::map_dfr(function(ccode) {
            # the item to read is 1 x 1 death rates
            read_hfd_country(ccode, item) %&gt;%
                # this adds the column "country" storing the country ISO code
                dplyr::mutate(ccode = ccode)
        }) %&gt;%
        # Phil added this to make it a tibble
        tibble() %&gt;% 
        # and add country name
        left_join(hfdcodes, by = "ccode")
}
```

Finally, run the function to download one item for a set of countries:

```{r}
CNTRIES &lt;- hfdcodes %&gt;% 
    filter(Name %in% c("United States", "Lithuania", "Japan")) %&gt;% 
    pull(ccode)

totbirthsRR_USA_LTU_JPN &lt;- read_hfd_countries_item(countries = CNTRIES, item = "totbirthsRR")
```

Let's make a graph from that (`r figure_nums(name = "livebirths", display = "cite")`).

```{r}
totbirthsRR_USA_LTU_JPN %&gt;% 
    mutate(TotalM = Total / 1000000) %&gt;% 
    ggplot( 
       mapping = aes(x = Year, y = TotalM)) +
    geom_line() +
    facet_wrap(~Name, ncol = 1, scales = "free_y") +
    ylab("live births") +
    xlab("year")
```
\    
*`r figure_nums(name = "livebirths", caption = "Live births x 1 million: Japan, Lithuania, USA (note non-standardized Y scale)")`*

## Git {#git}

This section is a brief introduction to [Git](https://git-scm.com/), the free and open source version control system for text-based files. Much of the material in this lesson is derived from the [Software Carpentry Git tutorial](https://swcarpentry.github.io/git-novice/).

### Why use version control?
Version control is simply having control over various versions of your documents. In the context of code-based research using text files such as `.R`, `.Rmd`, `.tex`, `.sql`, `.do`, at the simplest level, version control means having the ability to track changes to your files. In more advanced levels, you should be able to revert to previous versions, collaborate with others and know who did what and when, or to merge together edits made by more than one person

We covered one form of version control in a previous assignment and in the section of this document on [File systems](#file-systems). The version control system was simply keeping copies of existing files and naming new files according to a temporal sequence, with date being the suggested method of nomenclature.

While keeping backup, dated copies of files is not necessarily a bad approach, it suffers from a few major limitations, including:

1. because it relies on saving different versions of a file, it can lead to a proliferation of files
1. it is not often easy to know what changes were made from version to version

Jorge Cham's ([Piled Higher and Deeper](http://www.phdcomics.com)) comic points out what happens to a typical graduate student's "final" version:

[![](images/week05/phd101212s.png)](http://www.phdcomics.com)

### Why use Git?
Version controls systems have been in use since the early 1980s. Commonly used applications are RCS (Revision Control System), CVS (Concurrent Versions System), SVN (Subversion).  However, some of these require centralized servers, are limited in their capabilities, and are not free.

Git has multiple advantages:

* free
* supports complex work flows with branching, merging, etc., allowing multiple collaborators to work on the same set of files at the same time
* does not require a centralized server (version control can be managed completely within a single computer)
    * it is possible to use online repositories, such as Github.com
* can be used within RStudio
* has a large community of users (i.e., free advice)

### Limitations of version control systems
Although version control systems are quite useful, there are some potential drawbacks.

1. requires learning yet another somewhat-complicated system
1. requires mindfulness
    * recorded changes are best performed interactively
    * can only "undo" changes that were committed
1. designed for text files; cannot deal with binary files, e.g., Word or other formats

### A brief Git tutorial
Here we will be using the basic functions of Git while building up an Rmd file.

#### Setting up Git in RStudio
We will be working on CSDE Terminal Server 4 (see [Getting started on Terminal Server 4](#getting-started-on-terminal-server-4)). 

Start RStudio and open a web browser.

#### Creating a repository
Using the web browser, go to [Github.com](http://github.com) and create a repository named `git_r`.

![](images/week05/2021-02-04_21_21_47.png)

Make the repository public and add a README file.

![](images/week05/2021-02-04_21_37_13.png)

Switch back to RStudio and select `File &gt; New Project` and in the choice of project types, select `Version Control`. This will streamline the process of linking the RStudio project with Github.

![](images/week05/2021-02-04_21_39_10.png)

Choose `Git` as the type of version control.

![](images/week05/2021-02-04_21_39_46.png)

Enter the complete URL of your new Git repository. The project directly name should automatically be set as the base name pf the URL. If not, enter `git_r`.

![](images/week05/2021-02-04_21_52_48.png)

Because we need to define where on the local file system the project files will be stored, click `Browse` and navigate to your `H:` drive (note that this is your UDrive).

![](images/week05/2021-02-04_21_53_32.png)

After you have specified the repository URL, project directory name, and parent directory of the project directory, click `Create Project`.

![](images/week05/2021-02-04_21_54_04.png)

#### Tracking changes
One of the files we will change is [week_01.Rmd](files/week_01.Rmd), so download this to the main folder of your project.

The first file we will make changes to is `README.md`.

Add some text explaining what purpose the repository serves.

![](images/week05/2021-02-04_22_09_11.png)

Save the changes to the README.md file. If you do not see updates in the Git tab, click the `Refresh listing` button. You may need to do this frequently if your file changes are frequent. Note the status of files will only change when the files are saved.

![](images/week05/2021-02-04_22_37_42.png)

You should see a blue "M" next to the README.md file. Click the check box for `Staged` to prepare to commit the changes to the file and prepare to push to the remote server.

![](images/week05/2021-02-04_22_11_45.png)

Click `Commit` and a new window will open. Any deletions are shown with a light red background. Additions are shown with a light green background, and text that has not changed will have a white background.

Enter some explanatory text in the `Commit message` panel. This message will help identify historical commits. The explanatory text should succinctly describe any changes you have made.

The idea is to make commits each time you have substantially changed your code. If you wait too long between commits, the number of changes in a single commit may be unmanageable. But if commits are made too frequently, the number of commits may become unmanageable. Think of this similarly to how often you might make a new version of a document.

![](images/week05/2021-02-04_22_15_28.png)

Next, we will perform an initial pull/push. It is recommended in multi-user environments to perform a pull from the online repository before pushing. This lets you download to your local file system any files that have been updated by others.

In the Git tab, click the `Pull` icon.

![](images/week05/2021-02-04_22_17_19.png)


Since no changes have been made to the online files, we see the message "Already up to date".

![](images/week05/2021-02-04_22_17_41.png)

Next, click the `Push` icon to upload any changed files.

![](images/week05/2021-02-04_22_17_58.png)

At some point in the process of establishing the connection to Github, you may get some popups asking you to sign in. If this happens, proceed with the authorization.

![](images/week05/2021-02-04_22_19_18.png)

![](images/week05/2021-02-04_22_19_59.png)

![](images/week05/2021-02-04_22_20_08.png)

When the authorization is completed, the push will proceed. Your screen will look different, but the last line of text here shows a truncated version of the unique hash (identifier) of the push transaction. This unique hash will allow you to download previous versions of the file in case you made commits and pushes that caused unintended consequences.

![](images/week05/2021-02-04_22_20_32.png)

If you refresh the page for your repository, you should see the updates you made to the README.md file. This is the basic process for updating files, committing changes, and pushing to Github.

![](images/week05/2021-02-04_22_21_18.png)


Perform the same steps (click `Staged` then `Commit` for week_01.Rmd). Because this is a new file that was not in the Github repository, when it is committed, it will show in all green since all of the text has been added. 

![](images/week05/2021-02-04_22_46_24.png)

Repeat the pull/push cycle and then refresh your browser to show that the file was added to the online Github repository.

![](images/week05/2021-02-04_22_48_45.png)

If you click the file name you will see the contents.

![](images/week05/2021-02-04_22_49_07.png)

Let's make some changes to this file. Back in RStudio, add to the list of packages to load at line 51.

```
library(htmltools) # popup on Leaflet map
```

Change the description at line 122 to read 

```
... for a Leaflet map that has the Space Needle, Savery Hall, and the Woodland Park Zoo.
```

and change the code chunk to add two additional points and text popups for the point markers. The chunk should contain the following code:

```
# the Space Needle
snxy &lt;- data.frame(name = "Space Needle", x = -122.3493, y = 47.6205)
space_needle &lt;- st_as_sf(snxy, coords = c("x", "y"), crs = 4326)

# Savery Hall
shxy &lt;- data.frame(name = "Savery Hall", x = -122.3083, y = 47.6572)
savery_hall &lt;- st_as_sf(shxy, coords = c("x", "y"), crs = 4326)

# the Woodland Park Zoo
zooxy &lt;- data.frame(name = "Woodland Park Zoo", x = -122.3543, y = 47.6685)
wp_zoo &lt;- st_as_sf(zooxy, coords = c("x", "y"), crs = 4326)

# rbind() to put two points in one data frame
pts &lt;- rbind(space_needle, savery_hall, wp_zoo)

# a leaflet
m &lt;- leaflet() %&gt;% 
    addTiles() %&gt;% 
    addCircleMarkers(data = pts, label = ~htmlEscape(name))
m
```

Save the edits to the file and then tap the "knit" button or enter at the console prompt `rmarkdown::render("week_01.Rmd")` to generate the HTML file. You should see that now there are three point markers, and if you hover over any of the markers you will see the name popup.

![](images/week05/2021-02-04_22_32_50.png)

#### Git bash shell

Another interface you can use is the Git bash shell. To open the shell, click `Tools &gt; Shell`. 

![](images/week05/2021-02-04_22_01_34.png) 

All of the GUI commands we have used in RStudio are available in the shell. In fact, very little of the functionality of Git is available within RStudio. To take full advantage of Git, it is necessary to use the shell. There are a number of excellent tutorials on the use of the shell. For now because this is an introductory lesson, we will focus mainly on the RStudio interface,

The shell should be set to the project folder; if not you can enter e.g., `cd /H/git_r` (note that this corresponds to the Windows folder `H:\git_r`).

At the prompt, enter `git status`. This will show the status of all files, in this case showing that `week_01.Rmd` has been modified, and that there are some files that are not being tracked.

![](images/week05/2021-02-04_23_36_02.png)

#### Ignoring specific files
Sometimes we are not interested in particular files being committed or pushed to the repository. For version control, we are interested in managing the code that is used to create outputs rather than the outputs themselves, with the idea being that if you have the code, you can recreate any outputs.

So there are files that can be ignored, which are specified in the `.gitignore` file. Open the file and add the line `*.html`. This tells Git not to bother managing HTML files (under the assumption that these are the output of rendering Rmd files).

![](images/week05/2021-02-04_23_40_15.png)

Save the `.gitignore` file and re-run `git status` at the shell (by tapping the up arrow key on your keyboard and tapping Enter). You should see that the HTML file does not show up in the list of changed or untracked files.

![](images/week05/2021-02-04_23_42_51.png)

Add the line `*.Rproj` to the `.gitignore` file--this file should not be necessary in the repository.

Likewise, if you refresh the Git tab in RStudio, the HTML file is no longer listed.

![](images/week05/2021-02-04_23_43_13.png)

We will perform a few more tasks with the shell. Enter `add .gitignore` and `add week_01.Rmd`. This is the equivalent of clicking the `Staged` check box in RStudio.

![](images/week05/2021-02-04_23_45_14.png)

Refreshing the Git tab in RStudio will show that these two files are staged. This demonstrates that the RStudio Git environment is up to date with any changes made using the Git shell, and vice versa.

![](images/week05/2021-02-04_23_45_37.png)


#### Exploring file change history
Click `Commit` to prepare to commit the changes (addition of `.gitignore` and the changes to `week_01.Rmd`).

As previously mentioned, deleted lines are shown in light red, added lines in light green, and unchanged lines with no highlighting. Click the entry for `week_01.Rmd` and the changes are apparent. Line numbers on the far left are the original line numbers. The next column to the right shows updated line numbers.

This allows you to compare the currently saved version against the previous version of the file.

![](images/week05/2021-02-04_23_48_02.png)

Committing changes with the shell is done by entering 

`
git commit -m "somecomment"
`

This has the same effect as clicking `Commit` in RStudio and entering the comment.

Note that if we have not made some initial user configurations, Git will print some informative text about your identity. To avoid this and to tag future commits, use the `git config --global` commands, e.g., 

`
git config --global user.name "My Full Name"
git config --global user.email "myemailaddress@mydomain"
`

![](images/week05/2021-02-04_23_51_55.png)

Once the commit is performed, either with the RStudio GUI or with the shell, you can verify that no files are listed to be possibly staged.

![](images/week05/2021-02-04_23_53_10.png)

Perform another pull/push cycle and then refresh your web browser. Click on the commit comment.

![](images/week05/2021-02-05_00_10_46.png)

You will see the changes to the two files in the last commit/push. The `.gitignore` file has all of its lines in green, indicating they are all new with respect to the repository. The file `week_01.Rmd` shows the same changes on Github as we saw in the local view before pushing the commit to the server.


![](images/week05/2021-02-05_00_12_20.png)

#### Restoring a previous version
What good are all of these tracked changes if we cannot revert to a previous version of a file? Here we will make some intentional bad edits to a file, commit and push, but then retrieve a previous version of the file. Any version can be recovered. Note that this does not mean you can recover any and all edits to a file. It only means you can recover what changed between commits. For example, if I made a commit/push at noon, then made a lot of changes and saved the file multiple times before 5 PM and then made a commit/push, there would only be two versions of the file available in Git, the one committed at noon, and the one committed at 5 PM. For this reason it is worth making commit/push cycles every time you thing you might want to revert to a previous version.

The intentional bad change to `week_01.Rmd` is the complete removal of the code that produces the Leaflet map. See the following image.

![](images/week05/2021-02-05_00_13_13.png)

Perform the standard cycle: stage, commit (with a snarky comment), pull, and push.

![](images/week05/2021-02-05_00_14_07.png)

![](images/week05/2021-02-05_00_14_24.png)

![](images/week05/2021-02-05_00_16_23.png)

![](images/week05/2021-02-05_00_17_10.png)

You should see the large swath of deleted lines

![](images/week05/2021-02-05_00_21_01.png)


![](images/week05/2021-02-05_00_22_10.png)

Back in the Github, find and click the file name.

![](images/week05/2021-02-05_00_24_21.png)

The file contents will show the most recent saved version (missing the Leaflet map lines). Click on the `History` link, which will show all of the commits.

![](images/week05/2021-02-05_00_25_05.png)

Click the commit where you followed the questionable advice from your advisor.

![](images/week05/2021-02-05_00_25_23.png)

The missing lines are evident. What we would like to do is to go back to the version before the large deletion of lines.

![](images/week05/2021-02-05_00_25_40.png)

Identify the previous commit and click the clipboard icon to the left of the first characters of the commit hash. This will copy the hash, which is necessary for restoring that version.

![](images/week05/2021-02-05_00_39_46.png)

Back in the shell, enter

```
git show *****
```

where ***** is the hash. This will display encoded instructions for changes made to the file. Now enter

```
git show *****:week_01.Rmd
```

where `*****` is the hash.

![](images/week05/2021-02-05_00_40_36.png)

This applies the changes to the file for the commit represented by the hash. You will see the text that was present at that commit, which includes the deleted Leaflet map.

![](images/week05/2021-02-05_00_40_59.png)

To restore this previous version to a new file, enter

```
git show *****:week_01.Rmd &gt; week_01_someadditionaldescription.Rmd
```

This prints the contents of the previously committed file and redirects the output to the named file after the `&gt;` sign.

![](images/week05/2021-02-05_00_45_16.png)

If you open that file, you will see the restored text.

![](images/week05/2021-02-05_00_46_04.png)

#### Conclusion
This was a brief introduction to the main functionality of Git with RStudio and Github. If you expect to perform even a modest amount of coding, you could benefit from Git as a way to keep track of your work, collaborate with others, and avoid programming disasters due to inadvertent deletion of overwriting of files.

&lt;hr&gt;
Rendered at &lt;tt&gt;`r Sys.time()`&lt;/tt&gt;

&lt;hr&gt;
Rendered at &lt;tt&gt;`r Sys.time()`&lt;/tt&gt;

## Source code
File is at `r fnamepath`.

### Source code for this document

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

### Complete Rmd code

```{r comment=''}
cat(readLines(fnamepath), sep = '\n')
```</code></pre>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="week4.html"><span class="header-section-number">4</span> Week 4</a></div>
<div class="next"><a href="week6.html"><span class="header-section-number">6</span> Week 6</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#week5"><span class="header-section-number">5</span> Week 5</a></li>
<li><a class="nav-link" href="#week5">
Topics: Human Fertility Database (age-specific rates and summary indicators); Git
</a></li>
<li>
<a class="nav-link" href="#hmdrevisit"><span class="header-section-number">5.1</span> Human Fertility Database (age-specific rates and summary indicators)</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#country-code-abbreviations"><span class="header-section-number">5.1.1</span> Country code abbreviations</a></li>
<li><a class="nav-link" href="#hfd-items"><span class="header-section-number">5.1.2</span> HFD items</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#git"><span class="header-section-number">5.2</span> Git</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#why-use-version-control"><span class="header-section-number">5.2.1</span> Why use version control?</a></li>
<li><a class="nav-link" href="#why-use-git"><span class="header-section-number">5.2.2</span> Why use Git?</a></li>
<li><a class="nav-link" href="#limitations-of-version-control-systems"><span class="header-section-number">5.2.3</span> Limitations of version control systems</a></li>
<li><a class="nav-link" href="#a-brief-git-tutorial"><span class="header-section-number">5.2.4</span> A brief Git tutorial</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#source-code-4"><span class="header-section-number">5.3</span> Source code</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#source-code-for-this-document-4"><span class="header-section-number">5.3.1</span> Source code for this document</a></li>
<li><a class="nav-link" href="#complete-rmd-code-4"><span class="header-section-number">5.3.2</span> Complete Rmd code</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/CSDE-UW/csde502-winter-2022/blob/master/05-week05.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/CSDE-UW/csde502-winter-2022/edit/master/05-week05.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>UW CSDE 502 A Course Notes</strong>" was written by Phil Hurvitz. It was last built on 2022-02-19 10:09.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
